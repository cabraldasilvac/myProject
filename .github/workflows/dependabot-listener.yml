name: Verifica√ß√£o Di√°ria de Alertas de Seguran√ßa

on:
  schedule:
    - cron: '30 21 * * *'  # 15:45
  workflow_dispatch:

jobs:
  check-for-alerts:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: read

    steps:
      - name: Verificar Alertas do Dependabot via API
        id: get_alerts
        run: |
          alerts=$(gh api "repos/${{ github.repository }}/dependabot/alerts" --jq '[.[] | {number, state, severity: .security_vulnerability.severity, package: .dependency.package.name, url: .html_url}]')
          echo "ALERTS_JSON=$alerts" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.ACTION_PAT }}

      - name: Formatar Alertas para o Slack
        id: format_alerts
        if: steps.get_alerts.outputs.ALERTS_JSON != '[]'
        run: |
          FORMATTED_ALERTS=$(echo "${{ steps.get_alerts.outputs.ALERTS_JSON }}" | jq -r '
            .[] | "‚Ä¢ N√∫mero: #\(.number) - Pacote: `\(.package)` - Severidade: *\(.severity)* - Estado: `\(.state)`\nURL: <\(.url)|\(.url)>"' | sed 's/\\n/\n/g')
          echo "FORMATTED_ALERTS=$FORMATTED_ALERTS" >> $GITHUB_OUTPUT
          
      - name: Enviar Notifica√ß√£o para o Slack se houver alertas
        if: steps.get_alerts.outputs.ALERTS_JSON != '[]' && steps.get_alerts.outputs.ALERTS_JSON != ''
        uses: cabraldasilvac/security-alert-notifier-action@main
        with:
          slack-channel-id: "C099V8S4GDD"
          slack-message: |
            üì¢ *Resumo Di√°rio de Alertas de Seguran√ßa Abertos*
            *Reposit√≥rio:* ${{ github.repository }}
            *Alertas Encontrados:*
            ${{ steps.format_alerts.outputs.FORMATTED_ALERTS }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Confirmar que n√£o h√° alertas
        if: steps.get_alerts.outputs.ALERTS_JSON == '[]' || steps.get_alerts.outputs.ALERTS_JSON == ''
        run: echo "Nenhum alerta do Dependabot encontrado. Tudo certo!"
